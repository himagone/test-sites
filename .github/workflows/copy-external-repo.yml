name: Receive and sync target files
on:
  repository_dispatch:
    types: [target-updated]
permissions:
  contents: write
jobs:
  sync-target:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout receiving repo
        uses: actions/checkout@v3
        with:
          persist-credentials: true
      - name: Clone source repo
        uses: actions/checkout@v3
        with:
          repository: himagone/test-site-private
          token: ${{ secrets.DISPATCH_TOKEN }}
          path: source-repo
          ref: main

      - name: Copy updated files
        run: |
          for file in ${{ github.event.client_payload.changed_files }}; do
            mkdir -p "$(dirname "$file")"
            cp "source-repo/$file" "$file"
          done
      - name: Remove nested git metadata
        run: rm -rf source-repo/.git
      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push to main
        run: |
          git add .
          git diff --quiet || git commit -m "ðŸ›  Sync target files from upstream"
          git push origin main
